name: Generate Website
on:
  workflow_call:
    inputs:
      commit_resources:
        description: 'commit the resources after generating them. Requires the access_token to be passed'
        required: false
        default: false
        type: boolean
      bad_links_fail_build:
        description: 'a boolean flag that determines if bad links found by the link checker fail fast and stop a complete build'
        required: false
        default: true
        type: boolean
    secrets:
      access_token:
        description: 'the access token to use for commits'
        required: false

  workflow_dispatch:
    inputs:
      commit_resources:
        description: 'commit the resources after generating them. Requires a PAT defined as secrets.COMMIT_TOKEN'
        required: true
        default: false
        type: boolean
      bad_links_fail_build:
        description: 'a boolean flag that determines if bad links found by the link checker fail fast and stop a complete build'
        required: false
        default: true
        type: boolean
      create_issue:
        description: 'create new GitHub issue if broken links found'
        required: false
        default: false
        type: boolean
jobs:
  build-website:
    name: Build Website
    runs-on: ubuntu-20.04
    env:
      WORKFLOW_MONITORING_COMMAND_NOA: "echo 'NO TOKEN';curl -s -I  https://api.github.com/users/${{ github.actor }} | grep -E \"x-ratelimit-remaining|x-ratelimit-limit|x-ratelimit-used|^HTTP\""
      WORKFLOW_MONITORING_COMMAND_GHT: "echo 'GITHUB TOKEN';curl -s -I -H \"Authorization: token ${{ secrets.GITHUB_TOKEN }}\" -H \"Accept: application/vnd.github+json\" https://api.github.com/users/${{ github.actor }} | grep -E \"x-ratelimit-remaining|x-ratelimit-limit|x-ratelimit-used|^HTTP\""
      WORKFLOW_MONITORING_COMMAND_ACT: "echo 'ACCESS TOKEN';curl -s -I -H \"Authorization: token ${{ secrets.access_token }}\" -H \"Accept: application/vnd.github+json\" https://api.github.com/users/${{ github.actor }} | grep -E \"x-ratelimit-remaining|x-ratelimit-limit|x-ratelimit-used|^HTTP\""
      WORKFLOW_MONITORING_COMMAND_CMT: "echo 'COMMIT TOKEN';curl -s -I -H \"Authorization: token ${{ secrets.COMMIT_TOKEN }}\" -H \"Accept: application/vnd.github+json\" https://api.github.com/users/${{ github.actor }} | grep -E \"x-ratelimit-remaining|x-ratelimit-limit|x-ratelimit-used|^HTTP\""
      HUGO_VERSION: 0.110.0
      HUGO_CHECKSUM: "969eeabb570e9d674d374de37a9d4c8799edf91a9a4dd9115dd714d559b5ad46"
    steps:
    - name: Monitor Workflow Rate Limits
      run: |
        ${{ env.WORKFLOW_MONITORING_COMMAND_NOA }}
        ${{ env.WORKFLOW_MONITORING_COMMAND_GHT }}
        ${{ env.WORKFLOW_MONITORING_COMMAND_ACT }}
        ${{ env.WORKFLOW_MONITORING_COMMAND_CMT }}
      id: monitor_rate_limits_before
    # https://gohugo.io/hosting-and-deployment/hosting-on-github/
    # Install Hugo
    - name: Install Hugo CLI
      run: |
        wget -O ${{ runner.temp }}/hugo.deb https://github.com/gohugoio/hugo/releases/download/v${HUGO_VERSION}/hugo_extended_${HUGO_VERSION}_linux-amd64.deb \
        && echo "${HUGO_CHECKSUM} *${{ runner.temp }}/hugo.deb" | shasum -a 256 --strict -c \
        && sudo dpkg -i ${{ runner.temp }}/hugo.deb
    - name: Install Dart Sass
      run: sudo snap install dart-sass
    - name: Checkout
      uses: actions/checkout@c85c95e3d7251135ab7dc9ce3241c5835cc595a9 # v3.5.3
      with:
        submodules: recursive
        fetch-depth: 0
    - name: Install Node.js dependencies
      run: "[[ -f package-lock.json || -f npm-shrinkwrap.json ]] && npm ci || true"
    - name: Build with Hugo
      env:
        # For maximum backward compatibility with Hugo modules
        HUGO_ENVIRONMENT: production
        HUGO_ENV: production
      run: |
        hugo \
          -v \
          -s src/ \
          --config "config.yaml,development-config.yaml" \
          --gc \
          --minify \
          --debug
    - name: Upload artifact
      uses: actions/upload-artifact@0b7f8abb1508181956e8e162db84b466c27e18ce # v3.1.2
      with:
        name: website
        path: ./src/public
    - name: Monitor Workflow Rate Limits
      run: |
        ${{ env.WORKFLOW_MONITORING_COMMAND_NOA }}
        ${{ env.WORKFLOW_MONITORING_COMMAND_GHT }}
        ${{ env.WORKFLOW_MONITORING_COMMAND_ACT }}
        ${{ env.WORKFLOW_MONITORING_COMMAND_CMT }}
      id: monitor_rate_limits_after
    
  check-links:
    name: Check Links
    runs-on: ubuntu-20.04
    needs:
      - build-website
    steps:
    - name: Checkout
      uses: actions/checkout@c85c95e3d7251135ab7dc9ce3241c5835cc595a9 # v3.5.3
      with:
        submodules: recursive
        fetch-depth: 0
    - name: Open Website Artifact
      uses: actions/download-artifact@9bc31d5ccc31df68ecc42ccf4149144866c47d8a # v3.0.2
      with:
        name: website
        path: website
    - name: Check Directory Listing
      shell: bash
      run: |
        find ./
        ls -ltra ./
    - name: Check Links
      uses: lycheeverse/lychee-action@76ab977fedbeaeb32029313724a2e56a8a393548
      with:
        args: --exclude-file ./.github/workflows/config/.lycheeignore --verbose --no-progress --accept 200,206,429 './website/**/*.html' --exclude-mail
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    - name: Save Report
      uses: actions/upload-artifact@0b7f8abb1508181956e8e162db84b466c27e18ce # v3.1.2
      with:
        name: report
        path: ./lychee/out.md

  deploy-dev-website:
    name: Publish Development Version to NIST Pages
    runs-on: ubuntu-20.04
    needs:
      - build-website
      - check-links
    steps:
    - name: Open Website Artifact
      uses: actions/download-artifact@9bc31d5ccc31df68ecc42ccf4149144866c47d8a # v3.0.2
      with:
        name: website
        path: public
    - name: Check Directory Listing
      shell: bash
      run: |
        find ./
        ls -ltra ./
    - name: Deploy Website
      uses: peaceiris/actions-gh-pages@068dc23d9710f1ba62e86896f84735d869951305
      if: github.ref == 'refs/heads/main'
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        enable_jekyll: false
        publish_dir: ./public
        publish_branch: nist-pages
        user_name: OSCAL GitHub Actions Bot
        user_email: oscal@nist.gov
        commit_message: Deploying website [ci deploy]

  stage-website:
    name: Publish Website to OSCAL Branch for NIST Pages
    runs-on: ubuntu-20.04
    needs: 
      - build-website
      - check-links
      - deploy-dev-website
    steps:
      - name: Checkout
        uses: actions/checkout@c85c95e3d7251135ab7dc9ce3241c5835cc595a9 # v3.5.3
        with:
          ref: nist-pages
          persist-credentials: false
          submodules: recursive
          fetch-depth: 0
      - name: Open Website Artifact
        uses: actions/download-artifact@9bc31d5ccc31df68ecc42ccf4149144866c47d8a # v3.0.2
        with:
          name: website
          path: .
      - name: Check Directory Listing
        shell: bash
        run: |
          find ./
          ls -ltra ./
          git status
      # - name: Commit files
      #   run: |
      #     git config --local user.email "oscal@nist.gov"
      #     git config --local user.name "OSCAL GitHub Actions Bot"
      #     git commit -a -m "Updating website [ci deploy]"
      - name: Stage website in OSCAL Project
        uses: ad-m/github-push-action@40bf560936a8022e68a3c00e7d2abefaf01305a6 # v0.6.0
        with:
          github_token: ${{ secrets.access_token }}
          repository: usnistgov/OSCAL
          branch: next-pages
          force: true
          directory: '.'
